# Интеграция с 1С

## Обзор

Система поддерживает импорт данных из 1С:Предприятие через JSON-формат. Импорт позволяет синхронизировать:

- **Прицепы** (trailers) — основные товары каталога
- **Опции** (options) — дополнительное оборудование и аксессуары  
- **Склады** (warehouses) — складские точки с остатками

## Формат данных

### Структура JSON-файла

```json
{
  "_meta": {
    "export_date": "2025-01-15T10:00:00.000Z",
    "source": "1C:Enterprise 8.3",
    "version": "1.0"
  },
  "warehouses": [...],
  "trailers": [...],
  "options": [...]
}
```

### Прицепы (trailers)

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `guid_1c` | UUID | ✅ | Уникальный идентификатор из 1С |
| `model` | string | ✅ | Модель, напр. "МЗСА 817700.002" |
| `name` | string | ✅ | Название, напр. "Прицеп КОМПАКТ" |
| `article` | string | - | Артикул производителя (МЗСА) |
| `onr_article` | string | - | Артикул ОНР (внутренний) |
| `description` | string | - | Полное описание |
| `category` | string | ✅ | Категория: `general`, `water`, `commercial` |
| `base_price` | number | - | Базовая цена |
| `retail_price` | number | - | Розничная цена |
| `availability` | string | - | `in_stock`, `on_order`, `out_of_stock` |
| `delivery_days` | number | - | Срок доставки в днях (для on_order) |
| `images` | string[] | - | URL изображений |
| `badges` | string[] | - | Бейджи: "Хит продаж", "Новинка" |
| `specs` | object | - | Характеристики (см. ниже) |
| `features` | string[] | - | Список особенностей |
| `max_vehicle_length` | number | - | Макс. длина техники, мм |
| `max_vehicle_width` | number | - | Макс. ширина техники, мм |
| `max_vehicle_weight` | number | - | Макс. вес техники, кг |
| `compatibility` | string[] | - | Совместимость: `boat`, `atv`, `motorcycle`, `car`, `cargo`, `snowmobile` |
| `stock` | object | - | Остатки по складам: `{"SG-1": 3, "NV-1": 1}` |

### Характеристики (specs)

Поддерживаемые ключи:

```json
{
  "polnaya_massa": 750,          // Полная масса, кг
  "gruzopodemnost": 450,          // Грузоподъёмность, кг
  "snaryazhyonnaya_massa": 300,   // Снаряжённая масса, кг
  "gabaritnye_razmery": "2050×1100×1500",  // Габариты
  "vnutrennie_razmery": "1950×1000×300",   // Размеры кузова
  "vysota_bortov": 300,           // Высота бортов, мм
  "kolichestvo_osey": 1,          // Количество осей
  "tip_podveski": "рессорная",    // Тип подвески
  "tormoza": "нет",               // Тормоза
  "max_sudno": 4500               // Макс. длина судна (для лодочных)
}
```

### Опции (options)

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `guid_1c` | UUID | ✅ | Уникальный идентификатор из 1С |
| `name` | string | ✅ | Название опции |
| `article` | string | - | Артикул производителя |
| `onr_article` | string | - | Артикул ОНР (внутренний) |
| `description` | string | - | Описание |
| `category` | string | ✅ | Категория: `cover`, `loading`, `spare`, `safety`, `guides`, `boat_support` |
| `retail_price` | number | - | Цена |
| `images` | string[] | - | URL изображений |
| `compatible_trailers` | string[] | - | Массив `guid_1c` совместимых прицепов |
| `stock` | object | - | Остатки по складам |

### Склады (warehouses)

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `guid_1c` | UUID | ✅ | Уникальный идентификатор из 1С |
| `code` | string | ✅ | Код склада: "SG-1", "NV-1" |
| `name` | string | ✅ | Название |
| `city` | string | - | Город |
| `address` | string | - | Адрес |
| `warehouse_type` | string | - | Тип: `retail`, `wholesale`, `service`, `transit` |

## Маппинг категорий

При импорте категории автоматически нормализуются:

| Значения в 1С | Результат |
|---------------|-----------|
| `universal`, `universalnye`, `универсальные`, `бортовые`, `general` | `general` |
| `lodochnye`, `лодочные`, `water` | `water` |
| `commercial`, `коммерческие`, `furgon`, `фургон` | `commercial` |

## Способы импорта

### 1. Через админ-панель (рекомендуется)

1. Откройте `/admin#/import-1c`
2. Загрузите JSON-файл
3. Выберите режим импорта:
   - **Обновить** — обновить существующие записи и создать новые
   - **Полный** — полная синхронизация всех данных
   - **Только остатки** — обновить только складские остатки
4. Нажмите "Запустить импорт"
5. Просмотрите результаты и логи

### 2. Через CLI-скрипт

```bash
# Установка зависимостей
cd scripts
npm install typescript ts-node @supabase/supabase-js

# Запуск импорта
SUPABASE_SERVICE_KEY=your_key npx ts-node import_from_1c.ts \
  --file=./sample_1c_export.json \
  --mode=update

# Тестовый запуск (без записи в БД)
npx ts-node import_from_1c.ts \
  --file=./sample_1c_export.json \
  --mode=update \
  --dry-run
```

## Механизм синхронизации

### Идентификация записей

Записи идентифицируются по полю `guid_1c` (UUID из 1С). При импорте:

1. Если запись с таким `guid_1c` существует — обновляется
2. Если не существует — создаётся новая

### Поля синхронизации

Каждая запись получает служебные поля:

- `sync_status` — статус синхронизации: `synced`, `pending`, `error`
- `last_sync_at` — дата последней синхронизации
- `version_1c` — версия записи в 1С (опционально)

### Транзакционность

- Склады импортируются первыми
- Затем прицепы (с изображениями, характеристиками, features)
- Затем опции (с привязкой к прицепам)
- При ошибке в одной записи остальные продолжают обрабатываться

## Пример выгрузки из 1С

```json
{
  "_meta": {
    "export_date": "2025-01-15T10:00:00.000Z",
    "source": "1C:Enterprise 8.3",
    "version": "1.0"
  },
  "trailers": [
    {
      "guid_1c": "b2c3d4e5-0002-0002-0002-000000000001",
      "model": "МЗСА 817700.002",
      "name": "Прицеп КОМПАКТ",
      "category": "general",
      "retail_price": 125000,
      "availability": "in_stock",
      "specs": {
        "polnaya_massa": 750,
        "gruzopodemnost": 450
      },
      "features": ["Оцинкованный кузов", "Откидной борт"],
      "stock": {"SG-1": 3}
    }
  ]
}
```

## Обработчик 1С

Для автоматической выгрузки создайте обработчик в 1С:

```1c
// Псевдокод обработчика выгрузки
Процедура ВыгрузитьНоменклатуруJSON()
    
    Данные = Новый Структура;
    Данные.Вставить("_meta", Новый Структура);
    Данные._meta.Вставить("export_date", ТекущаяДата());
    Данные._meta.Вставить("source", "1C:Enterprise");
    Данные._meta.Вставить("version", "1.0");
    
    // Склады
    Склады = Новый Массив;
    Выборка = Справочники.Склады.Выбрать();
    Пока Выборка.Следующий() Цикл
        Склад = Новый Структура;
        Склад.Вставить("guid_1c", Строка(Выборка.Ссылка.УникальныйИдентификатор()));
        Склад.Вставить("code", Выборка.Код);
        Склад.Вставить("name", Выборка.Наименование);
        Склады.Добавить(Склад);
    КонецЦикла;
    Данные.Вставить("warehouses", Склады);
    
    // Номенклатура (Прицепы)
    Прицепы = Новый Массив;
    Выборка = Справочники.Номенклатура.Выбрать();
    Пока Выборка.Следующий() Цикл
        Если Выборка.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Прицеп Тогда
            // ... формирование структуры прицепа
            Прицепы.Добавить(Прицеп);
        КонецЕсли;
    КонецЦикла;
    Данные.Вставить("trailers", Прицепы);
    
    // Запись JSON
    ЗаписьJSON = Новый ЗаписьJSON;
    ЗаписьJSON.ОткрытьФайл("export.json");
    ЗаписатьJSON(ЗаписьJSON, Данные);
    ЗаписьJSON.Закрыть();
    
КонецПроцедуры
```

## Troubleshooting

### Ошибка "Категория не найдена"

Убедитесь, что категория указана корректно. Допустимые значения:
- `general` (универсальные/бортовые)
- `water` (лодочные)  
- `commercial` (коммерческие/фургоны)

### Ошибка "Склад не найден"

При импорте остатков убедитесь, что:
1. Склады импортированы до прицепов/опций
2. Коды складов в поле `stock` совпадают с `code` или `guid_1c` складов

### Дубликаты записей

Если создаются дубликаты вместо обновления:
1. Проверьте уникальность `guid_1c`
2. Убедитесь, что в базе есть индекс по `guid_1c`

## Безопасность

- Импорт доступен только администраторам
- Используйте Service Role Key (не anon key) для CLI-скрипта
- Храните ключи в переменных окружения
